<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI - Interface</title>
    
    <!-- Bibliothèques -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseOpacity { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
        
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .animate-pulse-soft { animation: pulseOpacity 2s infinite ease-in-out; }
        
        body, html, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .prose { color: #e5e7eb; font-size: 0.95rem; line-height: 1.6; }
        .prose strong { color: #fff; }
        .prose h1, .prose h2 { color: #fff; margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; }
        .prose code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 0.3em; }
        .prose pre { background: rgba(0,0,0,0.3); padding: 1em; border-radius: 0.5em; overflow-x: auto; }
        
        /* Style pour la réflexion transparente */
        .ai-thought {
            font-style: italic;
            opacity: 0.6;
            font-size: 0.85rem;
            border-left: 2px solid rgba(255,255,255,0.2);
            padding-left: 1rem;
            margin-bottom: 1rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const N8N_TEXT_WEBHOOK = "https://esmieunathan.app.n8n.cloud/webhook/e19ae4b2-a192-4512-9e5f-b03d0580be78"; 
        
        const THOUGHT_STEPS = [
            "Compréhension de la requête",
            "Analyse des fichiers",
            "Appel de la base documentaire",
            "Réflexion du modèle",
            "Rédaction du texte"
        ];

        const DEFAULT_CONFIG = {
            companyName: "Nexus AI",
            primaryColor: "#6366f1",
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></i>;
        };

        // --- COMPOSANT NEURAL GLOW ---
        const NeuralGlow = ({ color, mouseTracking }) => {
            const canvasRef = useRef(null);
            const animationRef = useRef(null);
            const glRef = useRef(null);
            const uniformsRef = useRef(null);
            const pointerRef = useRef({ x: 0, y: 0, tX: 0, tY: 0 });
            const colorRef = useRef(color);

            useEffect(() => { colorRef.current = color; }, [color]);

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [parseInt(result[1], 16)/255, parseInt(result[2], 16)/255, parseInt(result[3], 16)/255] : [0.1, 0.2, 0.8];
            };

            const vertexShaderSource = `
                precision mediump float;
                varying vec2 vUv;
                attribute vec2 a_position;
                void main() {
                    vUv = .5 * (a_position + 1.);
                    gl_Position = vec4(a_position, 0.0, 1.0);
                }
            `;

            const fragmentShaderSource = `
                precision mediump float;
                varying vec2 vUv;
                uniform float u_time;
                uniform float u_ratio;
                uniform vec2 u_pointer_position;
                uniform float u_scroll_progress;
                uniform vec3 u_base_color;

                vec2 rotate(vec2 uv, float th) {
                    return mat2(cos(th), sin(th), -sin(th), cos(th)) * uv;
                }

                float neuro_shape(vec2 uv, float t, float p) {
                    vec2 sine_acc = vec2(0.);
                    vec2 res = vec2(0.);
                    float scale = 8.;
                    for (int j = 0; j < 15; j++) {
                        uv = rotate(uv, 1.);
                        sine_acc = rotate(sine_acc, 1.);
                        vec2 layer = uv * scale + float(j) + sine_acc - t;
                        sine_acc += sin(layer) + 2.4 * p;
                        res += (.5 + .5 * cos(layer)) / scale;
                        scale *= (1.2);
                    }
                    return res.x + res.y;
                }

                void main() {
                    vec2 uv = .5 * vUv;
                    uv.x *= u_ratio;
                    vec2 pointer = vUv - u_pointer_position;
                    pointer.x *= u_ratio;
                    float p = clamp(length(pointer), 0., 1.);
                    p = .5 * pow(1. - p, 2.);
                    float t = .001 * u_time;
                    float noise = neuro_shape(uv, t, p);
                    noise = 1.2 * pow(noise, 3.);
                    noise += pow(noise, 10.);
                    noise = max(.0, noise - .5);
                    noise *= (1. - length(vUv - .5));
                    vec3 color = u_base_color;
                    color += (u_base_color * 0.5) * sin(3.0 * u_scroll_progress + 1.5);
                    gl_FragColor = vec4(color * noise, noise);
                }
            `;

            useEffect(() => {
                const canvas = canvasRef.current;
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return;
                glRef.current = gl;

                const createShader = (type, src) => {
                    const s = gl.createShader(type);
                    gl.shaderSource(s, src);
                    gl.compileShader(s);
                    return s;
                };

                const program = gl.createProgram();
                gl.attachShader(program, createShader(gl.VERTEX_SHADER, vertexShaderSource));
                gl.attachShader(program, createShader(gl.FRAGMENT_SHADER, fragmentShaderSource));
                gl.linkProgram(program);
                gl.useProgram(program);

                const uniforms = {};
                const count = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);
                for (let i = 0; i < count; i++) {
                    const info = gl.getActiveUniform(program, i);
                    uniforms[info.name] = gl.getUniformLocation(program, info.name);
                }
                uniformsRef.current = uniforms;

                const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
                const buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
                const posLoc = gl.getAttribLocation(program, 'a_position');
                gl.enableVertexAttribArray(posLoc);
                gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

                const resize = () => {
                    const dpr = Math.min(window.devicePixelRatio, 2);
                    canvas.width = window.innerWidth * dpr;
                    canvas.height = window.innerHeight * dpr;
                    gl.viewport(0, 0, canvas.width, canvas.height);
                    gl.uniform1f(uniforms.u_ratio, canvas.width / canvas.height);
                };
                window.addEventListener('resize', resize);
                resize();

                const render = () => {
                    const t = performance.now();
                    if (mouseTracking) {
                        pointerRef.current.x += (pointerRef.current.tX - pointerRef.current.x) * 0.2;
                        pointerRef.current.y += (pointerRef.current.tY - pointerRef.current.y) * 0.2;
                    } else {
                        pointerRef.current.x += (window.innerWidth/2 - pointerRef.current.x) * 0.05;
                        pointerRef.current.y += (window.innerHeight/2 - pointerRef.current.y) * 0.05;
                    }
                    
                    const rgb = hexToRgb(colorRef.current);
                    gl.uniform3f(uniforms.u_base_color, rgb[0], rgb[1], rgb[2]);
                    gl.uniform1f(uniforms.u_time, t);
                    gl.uniform2f(uniforms.u_pointer_position, pointerRef.current.x / window.innerWidth, 1 - pointerRef.current.y / window.innerHeight);
                    gl.uniform1f(uniforms.u_scroll_progress, window.pageYOffset / (2 * window.innerHeight));
                    
                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                    animationRef.current = requestAnimationFrame(render);
                };
                render();

                const handleMove = (e) => { 
                    pointerRef.current.tX = e.clientX || (e.touches && e.touches[0].clientX); 
                    pointerRef.current.tY = e.clientY || (e.touches && e.touches[0].clientY); 
                };

                window.addEventListener('pointermove', handleMove);
                window.addEventListener('touchmove', handleMove);

                return () => {
                    cancelAnimationFrame(animationRef.current);
                    window.removeEventListener('resize', resize);
                    window.removeEventListener('pointermove', handleMove);
                    window.removeEventListener('touchmove', handleMove);
                };
            }, [mouseTracking]);

            return <canvas ref={canvasRef} className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-95 z-0" style={{ backgroundColor: '#000' }} />;
        };

        // --- COMPOSANT MESSAGE AVEC RÉFLEXION ---
        const MessageContent = ({ content }) => {
            const thinkingMatch = content.match(/<thinking>([\s\S]*?)<\/thinking>/);
            const thinking = thinkingMatch ? thinkingMatch[1] : null;
            const mainContent = content.replace(/<thinking>[\s\S]*?<\/thinking>/, '').trim();

            return (
                <div className="prose">
                    {thinking && (
                        <div className="ai-thought flex flex-col gap-1">
                            <span className="text-[10px] uppercase tracking-widest font-bold opacity-50 flex items-center gap-2">
                                <Icon name="brain" size={10} /> Réflexion
                            </span>
                            <div dangerouslySetInnerHTML={{ __html: marked.parse(thinking) }} />
                        </div>
                    )}
                    <div dangerouslySetInnerHTML={{ __html: marked.parse(mainContent) }} />
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [sessions, setSessions] = useState([{ id: 1, title: 'Nouvelle conversation', messages: [] }]);
            const [activeSessionId, setActiveSessionId] = useState(1);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [thoughtStepIndex, setThoughtStepIndex] = useState(0);
            const [isRecording, setIsRecording] = useState(false);
            const [showImageSource, setShowImageSource] = useState(false);
            
            const [isConfigOpen, setIsConfigOpen] = useState(false);
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [glowColor, setGlowColor] = useState("#6366f1");
            const [enableMouseTracking, setEnableMouseTracking] = useState(true);

            const imageInputRef = useRef(null);
            const cameraInputRef = useRef(null);
            const messagesEndRef = useRef(null);
            const recognitionRef = useRef(null);

            const activeSession = sessions.find(s => s.id === activeSessionId) || sessions[0];
            const isHome = activeSession.messages.length === 0;

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [activeSession.messages, isLoading]);

            // Gestion des étapes de pensée pendant le chargement
            useEffect(() => {
                let interval;
                if (isLoading) {
                    setThoughtStepIndex(0);
                    interval = setInterval(() => {
                        setThoughtStepIndex(prev => (prev < THOUGHT_STEPS.length - 1 ? prev + 1 : prev));
                    }, 5000);
                }
                return () => clearInterval(interval);
            }, [isLoading]);

            useEffect(() => {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRec) {
                    recognitionRef.current = new SpeechRec();
                    recognitionRef.current.lang = 'fr-FR';
                    recognitionRef.current.onresult = (e) => setInputText(prev => prev + e.results[0][0].transcript);
                    recognitionRef.current.onend = () => setIsRecording(false);
                }
            }, []);

            const handleFileUpload = async (files) => {
                if (!files.length) return;
                setIsLoading(true);
                setShowImageSource(false);
                const fileMsg = { id: Date.now(), role: 'user', content: `Fichier envoyé : ${files[0].name}`, isFile: true };
                setSessions(prev => prev.map(s => s.id === activeSessionId ? { ...s, messages: [...s.messages, fileMsg] } : s));
                
                setTimeout(() => {
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? { ...s, messages: [...s.messages, { id: Date.now()+1, role: 'assistant', content: "J'ai bien reçu votre image. Que souhaitez-vous que j'en fasse ?" }] } : s));
                    setIsLoading(false);
                }, 1500);
            };

            const handleSendMessage = async () => {
                if (!inputText.trim()) return;
                const userMsg = { id: Date.now(), role: 'user', content: inputText };
                setSessions(prev => prev.map(s => s.id === activeSessionId ? { ...s, messages: [...s.messages, userMsg], title: s.messages.length === 0 ? inputText.slice(0, 20) : s.title } : s));
                setInputText('');
                setIsLoading(true);

                try {
                    const res = await fetch(N8N_TEXT_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg.content, sessionId: activeSessionId })
                    });
                    const data = await res.json();
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? { ...s, messages: [...s.messages, { id: Date.now() + 1, role: 'assistant', content: data.output || data.reply || "Réponse reçue." }] } : s));
                } catch (e) {
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? { ...s, messages: [...s.messages, { id: Date.now()+1, role: 'assistant', content: "Erreur de connexion.", isError: true }] } : s));
                } finally { setIsLoading(false); }
            };

            return (
                <div className="flex h-full relative text-white overflow-hidden bg-black">
                    <NeuralGlow color={glowColor} mouseTracking={enableMouseTracking} />
                    
                    {/* SIDEBAR */}
                    <aside className={`${isSidebarOpen ? 'w-72' : 'w-0'} transition-all duration-300 bg-black/60 backdrop-blur-xl border-r border-white/10 flex flex-col z-40 overflow-hidden`}>
                        <div className="w-72 flex flex-col h-full">
                            <div className="p-4 space-y-4">
                                <div className="flex justify-between items-center">
                                    <span className="font-bold text-lg px-2 opacity-80">Menu</span>
                                    <button onClick={() => setIsSidebarOpen(false)} className="p-2 hover:bg-white/10 rounded-lg"><Icon name="panel-left-close" /></button>
                                </div>
                                <button onClick={() => {
                                    const id = Date.now();
                                    setSessions([{ id, title: 'Nouveau chat', messages: [] }, ...sessions]);
                                    setActiveSessionId(id);
                                }} className="w-full flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 p-3 rounded-xl transition-all shadow-lg font-medium">
                                    <Icon name="plus" size={18} /> Nouveau chat
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar">
                                {sessions.map(s => (
                                    <div key={s.id} onClick={() => setActiveSessionId(s.id)} className={`p-3 rounded-xl text-sm cursor-pointer truncate flex items-center gap-3 transition-all ${activeSessionId === s.id ? 'bg-white/10 text-white' : 'hover:bg-white/5 text-white/50'}`}>
                                        <Icon name="message-square" size={14} /> {s.title}
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 border-t border-white/5">
                                <button onClick={() => setIsConfigOpen(true)} className="flex items-center gap-2 w-full p-2 hover:bg-white/5 rounded-lg text-sm opacity-60 hover:opacity-100 transition-opacity">
                                    <Icon name="settings" size={16} /> Paramètres
                                </button>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 flex flex-col relative z-10 h-full">
                        <header className="absolute top-0 w-full p-4 flex items-center gap-4 z-30">
                            {!isSidebarOpen && <button onClick={() => setIsSidebarOpen(true)} className="p-2 bg-black/40 rounded-lg backdrop-blur-md border border-white/10"><Icon name="panel-left" /></button>}
                            <h1 className="font-bold text-xl drop-shadow-md">{config.companyName}</h1>
                        </header>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 relative">
                            {isHome ? (
                                <div className="h-full flex flex-col items-center justify-center text-center animate-fadeIn">
                                    <div className="p-6 rounded-full bg-black/40 border border-white/10 backdrop-blur-2xl mb-8 shadow-2xl">
                                        <Icon name="sparkles" size={48} className="text-indigo-400" />
                                    </div>
                                    <h2 className="text-5xl font-bold mb-12">Comment puis-je <br/><span className="text-indigo-400 font-black">vous aider ?</span></h2>
                                </div>
                            ) : (
                                <div className="max-w-3xl mx-auto py-20 space-y-6">
                                    {activeSession.messages.map(m => (
                                        <div key={m.id} className={`flex gap-4 animate-fadeIn ${m.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${m.role === 'user' ? 'bg-indigo-600' : 'bg-black/60 border border-white/10'}`}>
                                                <Icon name={m.role === 'user' ? 'user' : 'bot'} size={18} />
                                            </div>
                                            <div className={`p-4 rounded-2xl max-w-[85%] backdrop-blur-xl border border-white/10 ${m.role === 'user' ? 'bg-indigo-600/60' : 'bg-black/40'}`}>
                                                <MessageContent content={m.content} />
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {/* CHARGEMENT DYNAMIQUE AVEC PHRASES DE RÉFLEXION */}
                                    {isLoading && (
                                        <div className="flex gap-4 animate-fadeIn">
                                            <div className="w-10 h-10 rounded-full flex items-center justify-center shrink-0 bg-black/60 border border-white/10">
                                                <Icon name="bot" size={18} className="animate-pulse" />
                                            </div>
                                            <div className="flex flex-col gap-2 py-2">
                                                <div className="flex items-center gap-3 text-white/40 text-sm animate-pulse-soft">
                                                    <Icon name="loader-2" size={14} className="animate-spin" />
                                                    <span className="transition-all duration-1000">
                                                        {THOUGHT_STEPS[thoughtStepIndex]}...
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>
                            )}
                        </div>

                        {/* INPUT BAR */}
                        <div className="p-4 pb-8 relative z-30">
                            <div className="max-w-3xl mx-auto">
                                <div className="bg-black/60 backdrop-blur-3xl border border-white/10 p-2 rounded-[32px] flex items-end gap-2 shadow-2xl transition-all focus-within:border-indigo-500/50">
                                    <div className="relative">
                                        <button 
                                            onClick={() => setShowImageSource(!showImageSource)} 
                                            className={`p-3 rounded-full transition-colors ${showImageSource ? 'bg-white/10 text-white' : 'text-white/40 hover:text-white'}`}
                                        >
                                            <Icon name="camera" />
                                        </button>
                                        
                                        {showImageSource && (
                                            <div className="absolute bottom-full left-0 mb-4 bg-[#121212] border border-white/10 rounded-2xl p-2 w-52 shadow-2xl animate-fadeIn">
                                                <button onClick={() => cameraInputRef.current.click()} className="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl text-sm transition-colors">
                                                    <Icon name="camera" size={16} /> Prendre une photo
                                                </button>
                                                <button onClick={() => imageInputRef.current.click()} className="w-full flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl text-sm transition-colors">
                                                    <Icon name="image" size={16} /> Choisir une image
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <textarea 
                                        className="flex-1 bg-transparent border-none outline-none py-3 px-2 text-white placeholder-white/20 resize-none max-h-32"
                                        placeholder="Posez votre question..."
                                        rows={1}
                                        value={inputText}
                                        onChange={e => setInputText(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())}
                                    />
                                    
                                    <button 
                                        onClick={() => { if(!isRecording) { recognitionRef.current?.start(); setIsRecording(true); } else { recognitionRef.current?.stop(); } }}
                                        className={`p-3 rounded-full ${isRecording ? 'text-red-500 animate-pulse' : 'text-white/40 hover:text-white'}`}
                                    >
                                        <Icon name="mic" />
                                    </button>
                                    
                                    <button onClick={handleSendMessage} className="bg-white text-black h-10 w-10 rounded-full flex items-center justify-center hover:scale-105 transition-transform shrink-0">
                                        <Icon name="arrow-up" size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <input type="file" ref={imageInputRef} className="hidden" accept="image/*" onChange={e => handleFileUpload(e.target.files)} />
                        <input type="file" ref={cameraInputRef} className="hidden" accept="image/*" capture="environment" onChange={e => handleFileUpload(e.target.files)} />
                    </main>

                    {/* CONFIG MODAL */}
                    {isConfigOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={() => setIsConfigOpen(false)}>
                            <div className="bg-[#121212] border border-white/10 p-6 rounded-3xl w-80 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-6">Personnalisation</h3>
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-bold uppercase opacity-40 mb-2">Couleur du Glow</label>
                                        <div className="flex items-center gap-3">
                                            <input type="color" value={glowColor} onChange={e => setGlowColor(e.target.value)} className="w-10 h-10 rounded-xl bg-transparent border border-white/10 cursor-pointer"/>
                                            <span className="font-mono text-sm opacity-60">{glowColor}</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium opacity-80">Suivi Souris</span>
                                        <button 
                                            onClick={() => setEnableMouseTracking(!enableMouseTracking)}
                                            className={`w-12 h-6 rounded-full relative transition-colors ${enableMouseTracking ? 'bg-indigo-600' : 'bg-white/10'}`}
                                        >
                                            <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${enableMouseTracking ? 'right-1' : 'left-1'}`} />
                                        </button>
                                    </div>
                                </div>
                                <button onClick={() => setIsConfigOpen(false)} className="w-full mt-8 py-3 bg-white text-black rounded-xl font-bold">Enregistrer</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
