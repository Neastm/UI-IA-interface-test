<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI - Interface</title>
    
    <!-- Chargement des bibliothèques nécessaires via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        body, html, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        
        /* Scrollbar personnalisée */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONFIGURATION EXTERNE ---
        const N8N_WEBHOOK_URL = "https://esmieunathan.app.n8n.cloud/webhook-test/e19ae4b2-a192-4512-9e5f-b03d0580be78"; 

        const DEFAULT_CONFIG = {
            companyName: "Nexus AI",
            agentName: "Nexus Agent",
            primaryColor: "#6366f1",
            secondaryColor: "#4f46e5",
            welcomeMessage: "Bonjour ! Je suis l'IA de Nexus. Comment puis-je vous aider aujourd'hui ?"
        };

        // Composant utilitaire pour les icônes Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></i>;
        };

        // --- NOUVEAU COMPOSANT NEURAL GLOW (VOTRE VERSION) ---
        const NeuralGlow = () => {
            const canvasRef = useRef(null);
            const animationRef = useRef(null);
            const glRef = useRef(null);
            const uniformsRef = useRef(null);
            const pointerRef = useRef({ x: 0, y: 0, tX: 0, tY: 0 });

            const vertexShaderSource = `
                precision mediump float;
                varying vec2 vUv;
                attribute vec2 a_position;
                void main() {
                    vUv = .5 * (a_position + 1.);
                    gl_Position = vec4(a_position, 0.0, 1.0);
                }
            `;

            const fragmentShaderSource = `
                precision mediump float;
                varying vec2 vUv;
                uniform float u_time;
                uniform float u_ratio;
                uniform vec2 u_pointer_position;
                uniform float u_scroll_progress;

                vec2 rotate(vec2 uv, float th) {
                    return mat2(cos(th), sin(th), -sin(th), cos(th)) * uv;
                }

                float neuro_shape(vec2 uv, float t, float p) {
                    vec2 sine_acc = vec2(0.);
                    vec2 res = vec2(0.);
                    float scale = 8.;
                    for (int j = 0; j < 15; j++) {
                        uv = rotate(uv, 1.);
                        sine_acc = rotate(sine_acc, 1.);
                        vec2 layer = uv * scale + float(j) + sine_acc - t;
                        sine_acc += sin(layer) + 2.4 * p;
                        res += (.5 + .5 * cos(layer)) / scale;
                        scale *= (1.2);
                    }
                    return res.x + res.y;
                }

                void main() {
                    vec2 uv = .5 * vUv;
                    uv.x *= u_ratio;
                    vec2 pointer = vUv - u_pointer_position;
                    pointer.x *= u_ratio;
                    float p = clamp(length(pointer), 0., 1.);
                    p = .5 * pow(1. - p, 2.);
                    float t = .001 * u_time;
                    float noise = neuro_shape(uv, t, p);
                    noise = 1.2 * pow(noise, 3.);
                    noise += pow(noise, 10.);
                    noise = max(.0, noise - .5);
                    noise *= (1. - length(vUv - .5));
                    vec3 color = vec3(0.1, 0.2, 0.8);
                    color += vec3(0.0, 0.1, 0.4) * sin(3.0 * u_scroll_progress + 1.5);
                    color = color * noise;
                    gl_FragColor = vec4(color, noise);
                }
            `;

            const createShader = (gl, sourceCode, type) => {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, sourceCode);
                gl.compileShader(shader);
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile error: ' + gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }
                return shader;
            };

            const createShaderProgram = (gl, vertexShader, fragmentShader) => {
                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    console.error('Program link error: ' + gl.getProgramInfoLog(program));
                    return null;
                }
                return program;
            };

            const getUniforms = (gl, program) => {
                let uniforms = {};
                let uniformCount = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);
                for (let i = 0; i < uniformCount; i++) {
                    let uniformName = gl.getActiveUniform(program, i).name;
                    uniforms[uniformName] = gl.getUniformLocation(program, uniformName);
                }
                return uniforms;
            };

            const initShader = () => {
                const canvas = canvasRef.current;
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return null;
                const vs = createShader(gl, vertexShaderSource, gl.VERTEX_SHADER);
                const fs = createShader(gl, fragmentShaderSource, gl.FRAGMENT_SHADER);
                const prog = createShaderProgram(gl, vs, fs);
                uniformsRef.current = getUniforms(gl, prog);
                const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
                const vbuf = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, vbuf);
                gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
                gl.useProgram(prog);
                const posLoc = gl.getAttribLocation(prog, 'a_position');
                gl.enableVertexAttribArray(posLoc);
                gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
                return gl;
            };

            const resizeCanvas = () => {
                const canvas = canvasRef.current;
                const gl = glRef.current;
                if (!canvas || !gl) return;
                const dpr = Math.min(window.devicePixelRatio, 2);
                canvas.width = window.innerWidth * dpr;
                canvas.height = window.innerHeight * dpr;
                gl.uniform1f(uniformsRef.current.u_ratio, canvas.width / canvas.height);
                gl.viewport(0, 0, canvas.width, canvas.height);
            };

            const render = () => {
                const gl = glRef.current;
                const uniforms = uniformsRef.current;
                const pointer = pointerRef.current;
                if (!gl || !uniforms) return;
                const time = performance.now();
                pointer.x += (pointer.tX - pointer.x) * 0.2;
                pointer.y += (pointer.tY - pointer.y) * 0.2;
                gl.uniform1f(uniforms.u_time, time);
                gl.uniform2f(uniforms.u_pointer_position, pointer.x / window.innerWidth, 1 - pointer.y / window.innerHeight);
                gl.uniform1f(uniforms.u_scroll_progress, window.pageYOffset / (2 * window.innerHeight));
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                animationRef.current = requestAnimationFrame(render);
            };

            useEffect(() => {
                glRef.current = initShader();
                resizeCanvas();
                render();

                const updatePos = (x, y) => { pointerRef.current.tX = x; pointerRef.current.tY = y; };
                const hResize = () => resizeCanvas();
                const hMove = (e) => updatePos(e.clientX, e.clientY);
                const hTouch = (e) => updatePos(e.touches[0].clientX, e.touches[0].clientY);
                const hClick = (e) => updatePos(e.clientX, e.clientY);

                window.addEventListener('resize', hResize);
                window.addEventListener('pointermove', hMove);
                window.addEventListener('touchmove', hTouch);
                window.addEventListener('click', hClick);

                return () => {
                    if (animationRef.current) cancelAnimationFrame(animationRef.current);
                    window.removeEventListener('resize', hResize);
                    window.removeEventListener('pointermove', hMove);
                    window.removeEventListener('touchmove', hTouch);
                    window.removeEventListener('click', hClick);
                };
            }, []);

            return <canvas ref={canvasRef} className="absolute inset-0 w-full h-full pointer-events-none opacity-95 z-0" style={{ backgroundColor: '#000000' }} />;
        };

        // --- COMPOSANT APPLICATION ---
        const App = () => {
            const [sessions, setSessions] = useState([{ id: 1, title: 'Nouvelle conversation', messages: [] }]);
            const [activeSessionId, setActiveSessionId] = useState(1);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [isRecording, setIsRecording] = useState(false);
            
            const recognitionRef = useRef(null);
            const fileInputRef = useRef(null);

            const activeSession = sessions.find(s => s.id === activeSessionId) || sessions[0];
            const isHome = activeSession.messages.length === 0;

            useEffect(() => {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRec) {
                    recognitionRef.current = new SpeechRec();
                    recognitionRef.current.lang = 'fr-FR';
                    recognitionRef.current.onresult = (e) => setInputText(prev => prev + e.results[0][0].transcript);
                    recognitionRef.current.onend = () => setIsRecording(false);
                }
            }, []);

            const toggleRecording = () => {
                if (!recognitionRef.current) return;
                if (isRecording) { recognitionRef.current.stop(); } 
                else { recognitionRef.current.start(); setIsRecording(true); }
            };

            const handleSendMessage = async (textOverride) => {
                const text = textOverride || inputText;
                if (!text.trim()) return;

                const userMsg = { id: Date.now(), role: 'user', content: text };
                setSessions(prev => prev.map(s => s.id === activeSessionId ? {
                    ...s, 
                    messages: [...s.messages, userMsg],
                    title: s.messages.length === 0 ? text.slice(0, 20) : s.title
                } : s));
                
                setInputText('');
                setIsLoading(true);

                try {
                    const res = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text, sessionId: activeSessionId })
                    });
                    const data = await res.json();
                    const output = data.output || data.message || data.text || (Array.isArray(data) ? data[0]?.output : "Pas de réponse.");
                    
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? {
                        ...s, 
                        messages: [...s.messages, { id: Date.now() + 1, role: 'assistant', content: output }]
                    } : s));
                } catch (e) {
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? {
                        ...s, 
                        messages: [...s.messages, { id: Date.now() + 1, role: 'assistant', content: "Erreur n8n.", isError: true }]
                    } : s));
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className={`flex h-full transition-colors duration-500 ${isDarkMode ? 'bg-[#000] text-white' : 'bg-white text-gray-900'}`}>
                    
                    {/* Sidebar */}
                    <aside className={`${isSidebarOpen ? 'w-64' : 'w-0'} bg-[#050505] border-r border-white/5 flex flex-col transition-all duration-300 overflow-hidden z-40`}>
                        <div className="p-4 flex items-center justify-between min-w-[250px]">
                            <button onClick={() => {
                                const id = Date.now();
                                setSessions([{ id, title: 'Nouveau chat', messages: [] }, ...sessions]);
                                setActiveSessionId(id);
                            }} className="flex-1 flex items-center gap-2 bg-white/5 hover:bg-white/10 p-2.5 rounded-xl border border-white/5 text-sm">
                                <Icon name="plus" size={16} /> Nouveau chat
                            </button>
                            <button onClick={() => setIsSidebarOpen(false)} className="ml-2 p-2 hover:bg-white/10 rounded-lg opacity-60">
                                <Icon name="panel-left-close" />
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar">
                            {sessions.map(s => (
                                <div key={s.id} onClick={() => setActiveSessionId(s.id)} className={`p-3 rounded-xl text-sm cursor-pointer truncate ${activeSessionId === s.id ? 'bg-indigo-600/20 text-indigo-400' : 'hover:bg-white/5 opacity-60'}`}>
                                    {s.title}
                                </div>
                            ))}
                        </div>
                    </aside>

                    {/* Main Area */}
                    <main className="flex-1 flex flex-col relative min-w-0 bg-transparent">
                        <header className="absolute top-0 w-full p-4 flex items-center justify-between z-30">
                            <div className="flex items-center gap-4">
                                {!isSidebarOpen && <button onClick={() => setIsSidebarOpen(true)} className="p-2 bg-white/5 rounded-lg backdrop-blur-md"><Icon name="panel-left" /></button>}
                                <h1 className="font-bold text-xl tracking-tight drop-shadow-lg">Nexus AI</h1>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto custom-scrollbar relative">
                            {isHome ? (
                                <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                                    <NeuralGlow />
                                    <div className="relative z-10 space-y-8 animate-fadeIn w-full max-w-2xl px-4">
                                        <div className="inline-flex p-4 rounded-3xl bg-indigo-500/10 border border-indigo-500/20 shadow-2xl backdrop-blur-md mb-4">
                                            <Icon name="sparkles" size={40} className="text-indigo-400" />
                                        </div>
                                        <h2 className="text-5xl font-bold leading-tight drop-shadow-xl mb-12">Comment puis-je <br/><span className="text-white/40">vous aider ?</span></h2>
                                        
                                        <div className="w-full">
                                            <div className="bg-[#1a1a1a]/95 backdrop-blur-3xl border border-white/10 p-2.5 rounded-[32px] flex items-center gap-2 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                                                <input 
                                                    className="flex-1 bg-transparent border-none outline-none py-4 px-6 text-lg text-white placeholder-white/30"
                                                    placeholder="Une idée ? Une question ?"
                                                    value={inputText}
                                                    onChange={e => setInputText(e.target.value)}
                                                    onKeyDown={e => e.key === 'Enter' && handleSendMessage()}
                                                />
                                                <button 
                                                    onClick={() => handleSendMessage()} 
                                                    className="bg-[#e4e4e7] hover:bg-white text-black h-12 w-12 rounded-full flex items-center justify-center transition-all shadow-lg shrink-0 mr-1"
                                                >
                                                    <Icon name="arrow-right" size={20} className="stroke-[1.5]" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-3xl mx-auto py-24 px-4 space-y-10 relative z-10">
                                    <NeuralGlow />
                                    {activeSession.messages.map(m => (
                                        <div key={m.id} className={`flex gap-5 animate-fadeIn relative z-20 ${m.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                            <div className={`w-9 h-9 rounded-xl flex items-center justify-center shrink-0 shadow-lg ${m.role === 'user' ? 'bg-zinc-700' : (m.isError ? 'bg-red-500' : 'bg-indigo-600')}`}>
                                                <Icon name={m.role === 'user' ? 'user' : 'bot'} size={18} />
                                            </div>
                                            <div className={`p-4 rounded-2xl max-w-[85%] shadow-xl backdrop-blur-md ${m.role === 'user' ? 'bg-zinc-800/80' : (m.isError ? 'bg-red-500/10 border border-red-500/20 text-red-400' : 'bg-white/5 border border-white/5')}`}>
                                                {m.content}
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && <div className="flex items-center gap-2 text-indigo-400 animate-pulse text-sm relative z-20"><Icon name="loader-2" className="animate-spin" size={16}/> Nexus analyse...</div>}
                                </div>
                            )}
                        </div>

                        {!isHome && (
                            <footer className="p-6 relative z-30">
                                <div className="max-w-3xl mx-auto flex items-end gap-2 bg-zinc-900/80 backdrop-blur-xl border border-white/10 p-2 rounded-3xl shadow-2xl">
                                    <button onClick={() => fileInputRef.current.click()} className="p-3 text-white/30 hover:text-white"><Icon name="plus" /></button>
                                    <textarea 
                                        className="flex-1 bg-transparent outline-none py-3 px-2 text-white placeholder-white/20 resize-none max-h-40"
                                        placeholder="Message..."
                                        rows={1}
                                        value={inputText}
                                        onChange={e => setInputText(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())}
                                    />
                                    <button onClick={toggleRecording} className={`p-3 rounded-full transition-all ${isRecording ? 'bg-red-500 text-white animate-pulse' : 'text-white/30 hover:text-white'}`}><Icon name="mic" /></button>
                                    <button onClick={() => handleSendMessage()} className="p-3 bg-white text-black rounded-xl hover:bg-zinc-200"><Icon name="arrow-right" /></button>
                                </div>
                                <input type="file" ref={fileInputRef} className="hidden" />
                            </footer>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
